# План восстановления системы ролей и доступа

## Текущее состояние

### ✅ Уже восстановлено:
1. **User entity** - обновлена роль на `'admin' | 'manager' | 'owner' | 'management_company'`
2. **Project entity** - добавлено поле `defaultManagerId` и `deletedAt` (soft delete)
3. **ManagementCompany entity** - создана сущность
4. **PortfolioGoal entity** - восстановлена структура
5. **OwnerProperty entity** - уже содержит `managerId` и `managementCompanyId`
6. **PropertyEvent entity** - уже содержит типы `manager_assigned` и `manager_changed`
7. **RegisterDto** - уже обновлен с новыми ролями
8. **Roles decorator** - уже содержит `OwnerOnly()`

### ❌ Требует восстановления/исправления:

## Этап 1: Восстановление DTO и исправление сервисов

### 1.1. Восстановить DTO для целей портфеля
- [ ] `create-goal.dto.ts` - создать DTO для создания цели
- [ ] `update-goal.dto.ts` - создать DTO для обновления цели

### 1.2. Исправить GoalsService
- [ ] Заменить `userId` на `ownerId` в методе `findByUserId`
- [ ] Переименовать метод в `findByOwnerId` или оставить название, но использовать `ownerId`

### 1.3. Проверить и обновить PortfolioController
- [ ] Проверить использование ролей в контроллере
- [ ] Убедиться, что используется `ownerId` вместо `userId`

## Этап 2: Миграция роли investor → owner

### 2.1. Создать миграционный скрипт
- [ ] Создать `migrate-investor-to-owner.ts` в `apps/api/src/scripts/`
- [ ] Скрипт должен:
  - Найти всех пользователей с ролью `'investor'`
  - Обновить их роль на `'owner'`
  - Логировать количество обновленных записей

### 2.2. Обновить скрипты инициализации БД
- [ ] `init-db.ts` - заменить `'investor'` на `'owner'`
- [ ] `init-sqlite.ts` - заменить `'investor'` на `'owner'`
- [ ] `setup-db.ts` - заменить `'investor'` на `'owner'`
- [ ] `setup-db-direct.ts` - заменить `'investor'` на `'owner'`
- [ ] `test-notifications.ts` - заменить `'investor'` на `'owner'`

## Этап 3: Обновление сервисов и контроллеров

### 3.1. Проверить все сервисы на использование роли investor
- [ ] `portfolio.service.ts` - проверить фильтрацию по ролям
- [ ] `property.service.ts` - проверить проверки прав доступа
- [ ] `manager.service.ts` - проверить логику доступа менеджеров
- [ ] `admin.service.ts` - проверить админские функции

### 3.2. Обновить guards и проверки прав
- [ ] Проверить `auth.guard.ts` или аналогичные guards
- [ ] Убедиться, что все проверки используют `'owner'` вместо `'investor'`

## Этап 4: Реализация логики назначения менеджера

### 4.1. Обновить PropertyService (создание OwnerProperty)
- [ ] В методе создания OwnerProperty добавить логику:
  1. Если в запросе указан `managerId` - использовать его
  2. Иначе, если у связанного `Project` есть `defaultManagerId` - использовать его
  3. Иначе `managerId = null`

### 4.2. Реализовать логирование назначений менеджеров
- [ ] В `ActivityService` добавить метод для логирования назначения менеджера
- [ ] При изменении `managerId` в OwnerProperty:
  - Если `managerId` был `null`, а стал не `null` → событие `manager_assigned`
  - Если `managerId` изменился с одного на другой → событие `manager_changed`
  - Если `managerId` стал `null` → событие `manager_removed` (если нужен такой тип)

### 4.3. Обновить DTO создания/обновления OwnerProperty
- [ ] `create-property.dto.ts` - добавить опциональное поле `managerId`
- [ ] `update-property.dto.ts` - добавить опциональное поле `managerId`

## Этап 5: Реализация прав доступа ADMIN

### 5.1. Обновить AdminService
- [ ] Добавить методы для редактирования OwnerProperty
- [ ] Добавить методы для назначения/изменения `ownerId`, `managerId`, `managementCompanyId`
- [ ] Добавить метод для установки `project.defaultManagerId`
- [ ] Все изменения должны логироваться через PropertyEvent

### 5.2. Обновить AdminController
- [ ] Добавить endpoints для:
  - Редактирования OwnerProperty
  - Назначения менеджера на объект
  - Назначения управляющей компании
  - Установки менеджера по умолчанию для проекта

### 5.3. Реализовать soft-delete проверки
- [ ] Убедиться, что все запросы к OwnerProperty и Unit исключают `deletedAt IS NOT NULL`
- [ ] Добавить проверки перед удалением (нельзя удалять, если есть связанные данные)

## Этап 6: Обновление фронтенда (если нужно)

### 6.1. Проверить API клиент
- [ ] Убедиться, что фронтенд использует правильные роли
- [ ] Обновить типы, если нужно

### 6.2. Проверить компоненты
- [ ] Проверить использование роли `investor` на фронтенде
- [ ] Заменить на `owner`, если найдено

## Этап 7: Тестирование

### 7.1. Проверка миграции
- [ ] Запустить миграционный скрипт
- [ ] Проверить, что все пользователи с ролью `investor` обновлены

### 7.2. Проверка создания OwnerProperty
- [ ] Создать объект без `managerId` и с `project.defaultManagerId` → должен назначиться менеджер
- [ ] Создать объект с явным `managerId` → должен использоваться указанный менеджер
- [ ] Создать объект без менеджера → `managerId` должен быть `null`

### 7.3. Проверка логирования
- [ ] Проверить создание событий при назначении менеджера
- [ ] Проверить создание событий при изменении менеджера

### 7.4. Проверка прав доступа
- [ ] Проверить, что ADMIN видит все объекты
- [ ] Проверить, что ADMIN может редактировать объекты
- [ ] Проверить, что MANAGER видит только свои объекты
- [ ] Проверить, что OWNER видит только свои объекты

## Порядок выполнения

1. **Этап 1** - Восстановление DTO и исправление сервисов (критично для работы)
2. **Этап 2** - Миграция ролей (критично для данных)
3. **Этап 3** - Обновление сервисов (критично для функциональности)
4. **Этап 4** - Логика назначения менеджера (новая функциональность)
5. **Этап 5** - Права ADMIN (новая функциональность)
6. **Этап 6** - Фронтенд (если нужно)
7. **Этап 7** - Тестирование (проверка всего)

## Оценка времени

- Этап 1: ~30 минут
- Этап 2: ~20 минут
- Этап 3: ~40 минут
- Этап 4: ~1 час
- Этап 5: ~1.5 часа
- Этап 6: ~30 минут (если нужно)
- Этап 7: ~1 час

**Итого: ~5-6 часов работы**

