'use client';

import { useState, useEffect } from 'react';
import { portfolioApi, PortfolioGoal, PortfolioForecasts, CreateGoalDto, OwnerProperty } from '../lib/api-client';
import { useToastContext } from './ToastProvider';

interface PropertyGoalsProps {
  property: OwnerProperty;
  onUpdate?: () => void;
}

const GOAL_TYPE_LABELS: Record<PortfolioGoal['goalType'], string> = {
  roi: 'ROI (%)',
  yearly_income: '–ì–æ–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥ ($)',
  properties_count: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤',
  portfolio_value: '–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è ($)',
  value_growth: '–ü—Ä–∏—Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ($)',
};

export default function PropertyGoals({ property, onUpdate }: PropertyGoalsProps) {
  const toast = useToastContext();
  const [goals, setGoals] = useState<PortfolioGoal[]>([]);
  const [forecasts, setForecasts] = useState<PortfolioForecasts | null>(null);
  const [loading, setLoading] = useState(true);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newGoal, setNewGoal] = useState<CreateGoalDto>({
    goalType: property.status === 'rental' ? 'yearly_income' : 'value_growth',
    targetValue: 0,
  });
  const [deleteConfirmGoalId, setDeleteConfirmGoalId] = useState<string | null>(null);
  const [editingGoal, setEditingGoal] = useState<PortfolioGoal | null>(null);
  const [editForm, setEditForm] = useState<{ targetValue: number; targetDate?: string; description?: string }>({
    targetValue: 0,
  });

  useEffect(() => {
    loadData();
  }, [property.id]);

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –∏ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  useEffect(() => {
    const handleFocus = () => {
      loadData();
    };
    const handleGoalsUpdate = () => {
      loadData();
    };
    
    window.addEventListener('focus', handleFocus);
    window.addEventListener('goals-updated', handleGoalsUpdate);
    
    return () => {
      window.removeEventListener('focus', handleFocus);
      window.removeEventListener('goals-updated', handleGoalsUpdate);
    };
  }, []);

  async function loadData() {
    try {
      setLoading(true);
      console.log('[PropertyGoals] –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ü–µ–ª–µ–π...');
      const [goalsData, forecastsData] = await Promise.all([
        portfolioApi.getActiveGoals(),
        portfolioApi.getForecasts().catch(() => null),
      ]);
      console.log('[PropertyGoals] –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ü–µ–ª–∏:', goalsData);
      console.log('[PropertyGoals] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–µ–ª–µ–π:', goalsData?.length || 0);
      if (goalsData && goalsData.length > 0) {
        console.log('[PropertyGoals] –î–µ—Ç–∞–ª–∏ —Ü–µ–ª–µ–π:', goalsData.map(g => ({ id: g.id, goalType: g.goalType, status: g.status, targetValue: g.targetValue })));
      }
      setGoals(goalsData || []);
      setForecasts(forecastsData);
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–π –∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤:', err);
      toast.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ü–µ–ª–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã');
      setGoals([]);
    } finally {
      setLoading(false);
    }
  }

  async function handleCreateGoal() {
    if (!newGoal.targetValue || newGoal.targetValue <= 0) {
      toast.error('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ');
      return;
    }

    try {
      console.log('[PropertyGoals] –°–æ–∑–¥–∞–µ–º —Ü–µ–ª—å:', newGoal);
      const createdGoal = await portfolioApi.createGoal(newGoal);
      console.log('[PropertyGoals] –¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞, –æ—Ç–≤–µ—Ç –æ—Ç API:', createdGoal);
      console.log('[PropertyGoals] –°—Ç–∞—Ç—É—Å —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ü–µ–ª–∏:', createdGoal?.status);
      
      toast.success('–¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞');
      setShowAddForm(false);
      setNewGoal({ goalType: property.status === 'rental' ? 'yearly_income' : 'value_growth', targetValue: 0 });
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ü–µ–ª—å –≤ —Å–ø–∏—Å–æ–∫ —Å—Ä–∞–∑—É (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
      if (createdGoal && createdGoal.status === 'active') {
        setGoals(prev => [createdGoal, ...prev]);
        console.log('[PropertyGoals] –¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ');
      }
      
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
      await loadData();
      console.log('[PropertyGoals] –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç—Ñ–µ–ª—è
      window.dispatchEvent(new CustomEvent('portfolio-updated'));
      
      onUpdate?.();
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏:', err);
      toast.error(err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å');
    }
  }

  function getProgress(goal: PortfolioGoal): number {
    if (goal.currentValue === null || goal.targetValue === 0) return 0;
    return Math.min((goal.currentValue / goal.targetValue) * 100, 100);
  }

  function formatValue(value: number | null, goalType: PortfolioGoal['goalType']): string {
    if (value === null) return 'N/A';
    if (goalType === 'roi') return `${value.toFixed(1)}%`;
    if (goalType === 'properties_count') return Math.round(value).toString();
    return `$${value.toLocaleString()}`;
  }

  async function handleDeleteGoal(goalId: string) {
    try {
      await portfolioApi.deleteGoal(goalId);
      toast.success('–¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞');
      setDeleteConfirmGoalId(null);
      await loadData();
      onUpdate?.();
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ü–µ–ª–∏:', err);
      toast.error(err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å');
    }
  }

  async function handleArchiveGoal(goalId: string) {
    try {
      await portfolioApi.updateGoal(goalId, { status: 'archived' });
      toast.success('–¶–µ–ª—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
      await loadData();
      onUpdate?.();
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏:', err);
      toast.error(err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å');
    }
  }

  function startEdit(goal: PortfolioGoal) {
    setEditingGoal(goal);
    setEditForm({
      targetValue: goal.targetValue,
      targetDate: goal.targetDate || undefined,
      description: goal.description || undefined,
    });
  }

  async function handleUpdateGoal() {
    if (!editingGoal) return;
    if (!editForm.targetValue || editForm.targetValue <= 0) {
      toast.error('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ');
      return;
    }

    try {
      await portfolioApi.updateGoal(editingGoal.id, editForm);
      toast.success('–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
      setEditingGoal(null);
      await loadData();
      onUpdate?.();
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏:', err);
      toast.error(err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å');
    }
  }

  // –ü—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
  const propertyForecast = property.status === 'rental' 
    ? {
        yearlyIncome: property.metrics?.reduce((sum, m) => sum + Number(m.yearlyIncome || 0), 0) || 0,
        valueGrowth: (Number(property.currentEstimate) || Number(property.purchasePrice) || 0) - (Number(property.purchasePrice) || 0),
      }
    : {
        yearlyIncome: property.expectedAdr && property.expectedOccupancy
          ? Number(property.expectedAdr) * 365 * (Number(property.expectedOccupancy) / 100)
          : 0,
        valueGrowth: (Number(property.currentEstimate) || Number(property.purchasePrice) || 0) - (Number(property.purchasePrice) || 0),
      };

  if (loading) {
    return (
      <div className="rounded-xl border border-white/10 bg-white/5 p-6">
        <div className="text-center text-white/60">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* –ü—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ */}
      <div className="rounded-xl border border-white/10 bg-white/5 p-6">
        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>üîÆ</span>
          <span>–ü—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞</span>
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="rounded-lg border border-white/10 bg-white/5 p-4">
            <div className="text-sm text-white/60 mb-1">
              {property.status === 'rental' ? '–ü—Ä–æ–≥–Ω–æ–∑ –≥–æ–¥–æ–≤–æ–≥–æ –¥–æ—Ö–æ–¥–∞' : '–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –¥–æ—Ö–æ–¥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è'}
            </div>
            <div className="text-xl font-semibold text-green-400">
              ${propertyForecast.yearlyIncome.toLocaleString()}
            </div>
            {property.status === 'rental' && (
              <div className="text-xs text-white/40 mt-1">–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –º–µ—Ç—Ä–∏–∫</div>
            )}
            {property.status === 'construction' && (
              <div className="text-xs text-white/40 mt-1">
                ADR: ${property.expectedAdr?.toLocaleString() || 'N/A'} √ó –ó–∞–Ω—è—Ç–æ—Å—Ç—å: {property.expectedOccupancy || 'N/A'}%
              </div>
            )}
          </div>
          <div className="rounded-lg border border-white/10 bg-white/5 p-4">
            <div className="text-sm text-white/60 mb-1">–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏—Ä–æ—Å—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</div>
            <div className={`text-xl font-semibold ${propertyForecast.valueGrowth >= 0 ? 'text-green-400' : 'text-red-400'}`}>
              ${propertyForecast.valueGrowth.toLocaleString()}
            </div>
            <div className="text-xs text-white/40 mt-1">
              {propertyForecast.valueGrowth >= 0 ? '–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç' : '–£–±—ã—Ç–æ–∫'}
            </div>
          </div>
        </div>
      </div>

      {/* –¶–µ–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è (–≤—Å–µ —Ü–µ–ª–∏, –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞) */}
      <div className="rounded-xl border border-white/10 bg-white/5 p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <span>üéØ</span>
            <span>–¶–µ–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è</span>
          </h2>
          <button
            onClick={() => setShowAddForm(!showAddForm)}
            className="rounded-lg border border-sabay-primary bg-sabay-primary/10 px-4 py-2 text-sm font-medium text-sabay-primary transition hover:bg-sabay-primary/20"
          >
            {showAddForm ? '–û—Ç–º–µ–Ω–∞' : '+ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å'}
          </button>
        </div>

        {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏ */}
        {showAddForm && (
          <div className="mb-6 p-4 rounded-lg border border-white/10 bg-white/5">
            <h3 className="text-sm font-medium mb-4">–ù–æ–≤–∞—è —Ü–µ–ª—å</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-2">–¢–∏–ø —Ü–µ–ª–∏</label>
                <select
                  value={newGoal.goalType}
                  onChange={(e) => setNewGoal({ ...newGoal, goalType: e.target.value as PortfolioGoal['goalType'] })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                >
                  {Object.entries(GOAL_TYPE_LABELS).map(([value, label]) => (
                    <option key={value} value={value}>
                      {label}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                <input
                  type="number"
                  value={newGoal.targetValue || ''}
                  onChange={(e) => setNewGoal({ ...newGoal, targetValue: parseFloat(e.target.value) || 0 })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–ü–µ—Ä–∏–æ–¥ –Ω–∞—á–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="date"
                  value={newGoal.periodFrom || ''}
                  onChange={(e) => setNewGoal({ ...newGoal, periodFrom: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  title="–° –∫–∞–∫–æ–π –¥–∞—Ç—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–∏"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–ü–µ—Ä–∏–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="date"
                  value={newGoal.periodTo || ''}
                  onChange={(e) => setNewGoal({ ...newGoal, periodTo: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  title="–ü–æ –∫–∞–∫—É—é –¥–∞—Ç—É —É—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–∏"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–î–∞—Ç–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="date"
                  value={newGoal.targetDate || ''}
                  onChange={(e) => setNewGoal({ ...newGoal, targetDate: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="text"
                  value={newGoal.description || ''}
                  onChange={(e) => setNewGoal({ ...newGoal, description: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
                />
              </div>
            </div>
            <div className="mt-4 flex gap-2">
              <button
                onClick={handleCreateGoal}
                className="rounded-lg bg-sabay-primary px-4 py-2 text-sm font-medium text-white transition hover:bg-sabay-primary/80"
              >
                –°–æ–∑–¥–∞—Ç—å
              </button>
              <button
                onClick={() => {
                  setShowAddForm(false);
                  setNewGoal({ goalType: property.status === 'rental' ? 'yearly_income' : 'value_growth', targetValue: 0 });
                }}
                className="rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium transition hover:bg-white/10"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        )}

        {/* –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏ */}
        {editingGoal && (
          <div className="mb-6 p-4 rounded-lg border border-blue-500/30 bg-blue-500/10">
            <h3 className="text-sm font-medium mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-2">–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                <input
                  type="number"
                  value={editForm.targetValue || ''}
                  onChange={(e) => setEditForm({ ...editForm, targetValue: parseFloat(e.target.value) || 0 })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–ü–µ—Ä–∏–æ–¥ –Ω–∞—á–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="date"
                  value={editForm.periodFrom || ''}
                  onChange={(e) => setEditForm({ ...editForm, periodFrom: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  title="–° –∫–∞–∫–æ–π –¥–∞—Ç—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–∏"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–ü–µ—Ä–∏–æ–¥ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="date"
                  value={editForm.periodTo || ''}
                  onChange={(e) => setEditForm({ ...editForm, periodTo: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  title="–ü–æ –∫–∞–∫—É—é –¥–∞—Ç—É —É—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–∏"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–î–∞—Ç–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="date"
                  value={editForm.targetDate || ''}
                  onChange={(e) => setEditForm({ ...editForm, targetDate: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input
                  type="text"
                  value={editForm.description || ''}
                  onChange={(e) => setEditForm({ ...editForm, description: e.target.value || undefined })}
                  className="w-full rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sabay-primary"
                  placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
                />
              </div>
            </div>
            <div className="mt-4 flex gap-2">
              <button
                onClick={handleUpdateGoal}
                className="rounded-lg bg-sabay-primary px-4 py-2 text-sm font-medium text-white transition hover:bg-sabay-primary/80"
              >
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
              <button
                onClick={() => setEditingGoal(null)}
                className="rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium transition hover:bg-white/10"
              >
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        )}

        {/* –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π */}
        {goals.length === 0 ? (
          <div className="text-center py-8 text-white/60">
            –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ü–µ–ª—å, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.
          </div>
        ) : (
          <div className="space-y-4">
            {goals.map((goal) => {
              const progress = getProgress(goal);
              const isCompleted = goal.status === 'completed' || progress >= 100;

              return (
                <div
                  key={goal.id}
                  className={`rounded-lg border p-4 ${
                    isCompleted
                      ? 'border-green-500/30 bg-green-500/10'
                      : 'border-white/10 bg-white/5'
                  }`}
                >
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-medium">{GOAL_TYPE_LABELS[goal.goalType]}</h3>
                        {isCompleted && (
                          <span className="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400">
                            –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ
                          </span>
                        )}
                      </div>
                      {goal.description && (
                        <p className="text-sm text-white/60 mb-2">{goal.description}</p>
                      )}
                      <div className="flex flex-wrap items-center gap-4 text-sm">
                        <span className="text-white/60">
                          –¢–µ–∫—É—â–µ–µ: <span className="text-white">{formatValue(goal.currentValue, goal.goalType)}</span>
                        </span>
                        <span className="text-white/60">
                          –¶–µ–ª—å: <span className="text-white">{formatValue(goal.targetValue, goal.goalType)}</span>
                        </span>
                        {goal.targetDate && (
                          <span className="text-white/60">
                            –î–æ: <span className="text-white">{new Date(goal.targetDate).toLocaleDateString('ru-RU')}</span>
                          </span>
                        )}
                      </div>
                    </div>
                    <div className="flex gap-2">
                      {goal.status === 'active' && (
                        <>
                          <button
                            onClick={() => startEdit(goal)}
                            className="text-blue-400 hover:text-blue-300 text-sm"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            onClick={() => handleArchiveGoal(goal.id)}
                            className="text-yellow-400 hover:text-yellow-300 text-sm"
                            title="–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å"
                          >
                            üì¶
                          </button>
                        </>
                      )}
                      <button
                        onClick={() => setDeleteConfirmGoalId(goal.id)}
                        className="text-red-400 hover:text-red-300 text-sm"
                        title="–£–¥–∞–ª–∏—Ç—å"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                  <div className="mt-3">
                    <div className="flex items-center justify-between text-xs text-white/60 mb-1">
                      <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                      <span>{progress.toFixed(1)}%</span>
                    </div>
                    <div className="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                      <div
                        className={`h-full transition-all ${
                          isCompleted ? 'bg-green-500' : 'bg-sabay-primary'
                        }`}
                        style={{ width: `${progress}%` }}
                      />
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è */}
        {deleteConfirmGoalId && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50" onClick={() => setDeleteConfirmGoalId(null)}>
            <div className="rounded-xl border border-white/10 bg-slate-900 p-6 max-w-md w-full mx-4" onClick={(e) => e.stopPropagation()}>
              <h3 className="text-lg font-semibold mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
              <p className="text-white/60 mb-6">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
              <div className="flex gap-2">
                <button
                  onClick={() => handleDeleteGoal(deleteConfirmGoalId)}
                  className="flex-1 rounded-lg bg-red-500 px-4 py-2 text-sm font-medium text-white transition hover:bg-red-600"
                >
                  –£–¥–∞–ª–∏—Ç—å
                </button>
                <button
                  onClick={() => setDeleteConfirmGoalId(null)}
                  className="flex-1 rounded-lg border border-white/10 bg-white/5 px-4 py-2 text-sm font-medium transition hover:bg-white/10"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

